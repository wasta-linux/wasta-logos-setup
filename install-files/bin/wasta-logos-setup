#!/bin/bash

# ==============================================================================
# Logos Wine Setup
#   - Patch Wine
#   - Create Logos Wine Prefix
#   - Install .NET 4.7.2 in Logos Wine Prefix
#   - Install Logos
#
#   2019-09-28 rik: initial script
#   2019-10-04 rik: adding logos download option and additional error processing
#   2019-10-06 rik: adding winetricks ddr=gdi to address graphical glitches
#   2019-10-10 rik: moving winetricks to /usr/local/bin
#   2019-10-20 rik: re-working logic to determine if postinst needs run
#
# ==============================================================================

# ------------------------------------------------------------------------------
# Ensure script running as regular user
# ------------------------------------------------------------------------------
if [ $(id -u) -eq 0 ]
then
    echo "wasta-msoffice-setup started as root user."
    echo "No processing done.  Exiting...."
    exit 0
fi

# ------------------------------------------------------------------------------
# Function: setupPrefix
#
#   Setup Prefix for Logos
# ------------------------------------------------------------------------------
setupPrefix () {
    cleanupPrefix

    # copy in winetricks cache
    rsync -av $DIR/resources/winetricks-cache/ $HOME/.cache/winetricks/ | tee >(zenity \
        --height=150 --width=450 --progress --pulsate --auto-close \
        --window-icon=$DIR/resources/wasta-linux.png \
        --title="Copying Winetricks Cache" \
        --text="Copying Winetricks Cache...")

# # split --bytes 45M --numeric-suffixes --suffix-length=1 directx_feb2010_redist.exe directx_feb2010_redist.exe.

# cat directx_feb2010_redist.exe.* > directx_feb2010_redist.exe-new

    # setup prefix
    # Note: WINEDLLOVERRIDES was added to try to prevent mono and gecko prompts.
    #   But some users are having freezing issues so I am reverting this.
    WINEPREFIX=$PREFIX WINEARCH=win32 WINEDLLOVERRIDES="mscoree,mshtml=" wineboot | zenity \
        --height=150 --width=450 --progress --pulsate --auto-close \
        --window-icon=$DIR/resources/wasta-linux.png \
        --title="Setting up Wine Prefix" \
        --text="Setting up Wine Prefix... \n\n" &
    # get zenity process id
    PID_ZENITY=${!}

    # get firstly created process id, which is running parallel to zenity
    PID_PROCESS=$(pgrep -o -P $$)

    progressCheck $PID_ZENITY $PID_PROCESS
    if [ "$?" -eq 99 ];
    then
        # zenity canceled, Prefix setup didn't complete
        # some failure: exit
        errorExit "<b>Setup of Logos Wine Prefix failed!</b>"
    fi

    WINEPREFIX=$PREFIX /usr/local/bin/winetricks -q dotnet472 | zenity \
        --height=150 --width=450 --progress --pulsate --auto-close \
        --window-icon=$DIR/resources/wasta-linux.png \
        --title="Installing .NET 4.7.2" \
        --text="Installing .NET 4.7.2... \n
<i>Please be patient: this could take up to 30 minutes</i>\n" &
    # get zenity process id
    PID_ZENITY=${!}

    # get firstly created process id, which is running parallel to zenity
    PID_PROCESS=$(pgrep -o -P $$)

    progressCheck $PID_ZENITY $PID_PROCESS
    if [ "$?" -eq 99 ];
    then
        # zenity canceled, .NET install didn't complete
        errorExit "<b>.NET 4.7.2 install in Logos Wine Prefix failed!</b>"
    fi

    WINEPREFIX=$PREFIX /usr/local/bin/winetricks -q corefonts | zenity \
        --height=150 --width=450 --progress --pulsate --auto-close \
        --window-icon=$DIR/resources/wasta-linux.png \
        --title="Installing CoreFonts" \
        --text="Installing Corefonts... \n" &
    # get zenity process id
    PID_ZENITY=${!}

    # get firstly created process id, which is running parallel to zenity
    PID_PROCESS=$(pgrep -o -P $$)

    progressCheck $PID_ZENITY $PID_PROCESS
    if [ "$?" -eq 99 ];
    then
        # zenity canceled, Corefonts install didn't complete
        errorExit "<b>Corefonts install in Logos Wine Prefix failed!</b>"
    fi

    # set fontsmoothing
    # https://wiki.archlinux.org/index.php/Wine#Enable_font_smoothing
    WINEPREFIX=$PREFIX /usr/local/bin/winetricks settings fontsmooth=rgb

    # 2019-10-06 rik: not needed as ddr=gdi solves glitching
    # prevent window manager from decorating windows (attempting to reduce
    #   graphical glitching
    # WINEPREFIX=$PREFIX /usr/local/bin/winetricks settings windowmanagerdecorated=n

    #SetDirectDrawRender to GDI (solves graphical glitching of various menus,
    #   etc disappearing / reappearing.
    WINEPREFIX=$PREFIX /usr/local/bin/winetricks ddr=gdi

    cleanupPrefix
}

# ------------------------------------------------------------------------------
# Function: errorExit
#
#   exit script with passed message
# ------------------------------------------------------------------------------
errorExit () {
    zenity --error --no-wrap --height=200 \
        --title="wasta-logos-setup: Error" \
        --window-icon=$DIR/resources/wasta-linux.png \
        --text="$1 \n
<i>wasta-logos-setup will now exit.</i>" >/dev/null 2>&1
    exit 1
}

# ------------------------------------------------------------------------------
# Function: cleanupPrefix
#
#   various cleanup items for the Logos wine prefix
# ------------------------------------------------------------------------------
cleanupPrefix () {
    # remove desktop entries referencing $PREFIX.
    # note: grep --null returns null separated list to handle space in filenames
    # note: xargs -0 to handle null separated items
    grep -r -l --null "$PREFIX" "$HOME/.local/share/applications" \
        | xargs -0 rm >/dev/null 2>&1
}

# ------------------------------------------------------------------------------
# Function: progressCheck
#
#   Check on process launched in parallel with zenity. If zenity is canceled,
#   then kill process.
# ------------------------------------------------------------------------------
progressCheck () {
    echo
    echo "Watching zenity process. If it is canceled then kill PID_PROCESS: $PID_PROCESS"
    echo

    # loop to check that progress dialog has not been cancelled
    while [ "$PID_ZENITY" != "" ]
    do
        # check if zenity PID is still there (dialog box still open)
        PID_ZENITY=$(ps h -o pid --pid ${PID_ZENITY} | xargs)

        # sleep for 2 second
        sleep 2
    done

    # if other task still there, kill it
    ps "${PID_PROCESS}"
    if [ "$?" -eq 0 ];
    then
        # parallel process STILL FOUND: user canceled so kill it!
        echo
        echo "Zenity process ended (canceled) before parallel process: Killing PID_PROCESS: $PID_PROCESS"
        echo
        kill -9 ${PID_PROCESS}
        return 99
    else
        # parallel process NOT found after zenity completed: both completed
        echo
        echo "Zenity process and parallel process both ended: success"
        echo
        return 0
    fi
}

# ==============================================================================
# Main Processing
# ==============================================================================

# wasta-logos-setup directory (for resources)
DIR=/usr/share/wasta-logos-setup
PREFIX=/home/$USER/.wine-logos

#version 8.8.0.0036 added on 10/3/2019
LOGOS_DOWNLOAD_FILE=https://downloads.logoscdn.com/LBS8/Installer/8.8.0.0039/Logos-x86.msi
LOGOS_MD5=bc47826112cef8d6a35291240b80f198

zenity --question --no-wrap --height=200 --width=500 \
    --title="wasta-logos-setup" \
    --window-icon=$DIR/resources/wasta-linux.png \
    --text="<b>Do you want to install Logos using Wine?</b>\n
<b>Processing Summary:</b>
   * Ensure Wine patched for Logos compatibility <i>(optional)</i>
   * Create a 'Logos Wine Prefix'
   * Install .NET 4.7.2
   * Install Logos"
if [ "$?" -ne 0 ];
then
    # User didn't said yes: exit
    exit 0
fi

# ------------------------------------------------------------------------------
# Optionally patch kernelbase.dll (if an administrator)
# ------------------------------------------------------------------------------

# NOTE: may need to patch even if previously patched, because wine may have
#   updated.

WINE_VERSION=$(wine --version)
TEMP=${WINE_VERSION/wine-/}
WINE_VERSION_FORMAT=${TEMP/./-}

PATCH_FILE="$DIR/resources/kernelbase-$WINE_VERSION_FORMAT.dll"
DLL_SOURCE=$(readlink -f /opt/wine-devel/lib/wine/kernelbase.dll)

WASTA_WINETRICKS="$DIR/resources/winetricks"
WINETRICKS_SOURCE=$(readlink -f "/usr/local/bin/winetricks")

# Check for matching wine version and winetricks - if NOT then re-run postinst
if ! [ "$PATCH_FILE" == "$DLL_SOURCE" ] | ! [ "$WINETRICKS_SOURCE" == "$WASTA_WINETRICKS" ];
then 
    # prompt for running wasta-logos-setup postinst
    zenity --question --title "Patch Wine and Winetricks" \
        --no-wrap --height=150 --width=450 \
        --window-icon=$DIR/resources/wasta-linux.png \
        --text="<b>Updates needed to Wine or Winetricks for Logos compatibility.</b>\n
<i>NOTE: you will need to provide an administrative password</i>\n"
RUN_PATCH=$?

    if [ "$RUN_PATCH" == 0 ];
    then
        pkexec $DIR/wasta-logos-setup-postinst.sh
        RETURN=$?
        if [ "$RETURN" -ne 0 ];
        then
            # didn't return clean from postinst: get outta here!
            exit 1
        fi
    fi
fi

# ------------------------------------------------------------------------------
# Setup Logos Prefix and install Logos
# ------------------------------------------------------------------------------

if [ -d "$PREFIX" ];
then
    # Wine PREFIX exists, ask user if they want to overwrite it or update it
    zenity --question --no-wrap --height=200 --width=500 \
        --title="wasta-logos-setup" \
        --window-icon=$DIR/resources/wasta-linux.png \
        --text="<b>Remove existing Logos Wine Prefix?</b>\n
<i>The folder <u>'$PREFIX'</u> already exists.  Do you want to
delete it in order to re-setup a new Logos Wine Prefix?</i>\n"

    if [ "$?" -eq 0 ];
    then
        # remove PREFIX
        rm -rf $PREFIX
    fi
    setupPrefix
else
    # No Wine PREFIX: prompt user
    zenity --question --no-wrap --height=200 --width=500 \
        --title="wasta-logos-setup" \
        --window-icon=$DIR/resources/wasta-linux.png \
        --text="<b>Setup Logos Wine Prefix?</b>\n
<i>Do you want to setup a new Logos Wine Prefix?</i>\n"

    if [ "$?" -eq 0 ];
    then
        # User said yes: setup PREFIX
        setupPrefix
    else
        # exit
        exit 0
    fi
fi

if [ -d "$PREFIX" ];
then
    INSTALL_FILE=""
    if ! [ -e "$HOME/Downloads/Logos-x86.msi" ];
    then
        zenity --question --no-wrap --height=200 --width=500 \
            --title="Download Logos?" --ok-label="Continue" \
            --window-icon=$DIR/resources/wasta-linux.png \
            --text="'Logos-x86.msi' wasn't found in your Downloads folder.\n
<b>Download Logos-x86.msi from the internet?</b>\n
<i>If you answer 'no' then you will be prompted to locate your 'Logos-x86.msi' file.</i>\n"

        if [ "$?" -eq 0 ];
        then
            # User said yes: Download Logos-x86.msi
            # -t: retry 5 times
            # -c: continue (resume broken download)
            wget -c -N -t 5 -O $HOME/Downloads/Logos-x86.msi $LOGOS_DOWNLOAD_FILE | zenity \
                --height=150 --width=450 --progress --pulsate --auto-close \
                --window-icon=$DIR/resources/wasta-linux.png \
                --title="Downloading Logos Installer" \
                --text="Logos-x86.msi is being downloaded...\n\n" &

            # get zenity process id
            PID_ZENITY=${!}

            # get firstly created process id, which is running parallel to zenity
            PID_PROCESS=$(pgrep -o -P $$)

            progressCheck $PID_ZENITY $PID_PROCESS
            if [ "$?" -eq 99 ];
            then
                # zenity canceled, download didn't complete
                # didn't exist previously so delete if found
                rm -f "$HOME/Downloads/Logos-x86.msi"
                zenity --info --no-wrap --height=200 \
                    --title="Download Failed" \
                    --window-icon=$DIR/resources/wasta-linux.png \
                    --text="<b>Logos-x86.msi Download failed:</b>\n
You will now be prompted for an existing Logos-x86.msi file."
            else
                #check md5
                MD5_CHECK=($(md5sum "$HOME/Downloads/Logos-x86.msi"))
                echo "MD5_CHECK: $MD5_CHECK"
                echo "LOGOS_MD5: $LOGOS_MD5"
                if [ "$MD5_CHECK" == "$LOGOS_MD5" ];
                then
                    INSTALL_FILE="$HOME/Downloads/Logos-x86.msi"
                else
                    # didn't exist previously so delete if found
                    rm -f "$HOME/Downloads/Logos-x86.msi"
                    zenity --info --no-wrap --height=200 \
                    --title="Checksum Failed" \
                    --window-icon=$DIR/resources/wasta-linux.png \
                    --text="<b>Logos-x86.msi checksum failed:</b>\n
You will now be prompted for an existing Logos-x86.msi file."
                fi
            fi
        fi

        if [ "$INSTALL_FILE" == "" ];
        then
            # DON'T check md5 because could be a newer version?
            INSTALL_FILE=$(zenity --file-selection \
                --window-icon=$DIR/resources/wasta-linux.png \
                --title="Select your Logos 32-bit Installation File")
            OUTNUM=$?
            if [ "$OUTNUM" -ne 0 ];
            then
                errorExit "File Dialog cancelled"
            fi
        fi
    else
        # DON'T check md5 because could be a newer version?
        INSTALL_FILE="$HOME/Downloads/Logos-x86.msi"
        zenity --info --no-wrap --height=200 \
            --title="Logos Installer Found" \
            --window-icon=$DIR/resources/wasta-linux.png \
            --text="<b>Logos-x86.msi</b> was found in your <b>Downloads</b> folder.\n
Proceeding with installation..."
    fi

    echo "Install file: $INSTALL_FILE"

    if [ "$INSTALL_FILE" ];
    then
        # Set Wine to win7 for Logos install
        WINEPREFIX=$PREFIX winetricks -q win7

        WINEPREFIX=$PREFIX msiexec /i "$INSTALL_FILE"
        OUTNUM=$?
        if [ "$OUTNUM" -ne 0 ];
        then
            # some failure: exit
            errorExit "<b>Logos installation failed!</b>\n
<i>Some error encountered with installation file:</i>\n
$INSTALL_FILE"
        fi

        # add LC_ALL=C
        sed -i -e "s@\(Software.lnk$\)@\1 LC_ALL=C@" $HOME/.local/share/applications/wine/Programs/Logos\ Bible\ Software.desktop

        # Set Wine to winxp for Logos Usage
        WINEPREFIX=$PREFIX winetricks -q winxp

        zenity --info --no-wrap --height=200 \
            --title="wasta-logos-setup: Complete" \
            --window-icon=$DIR/resources/wasta-linux.png \
            --text="<b>Logos setup complete!</b>\n
<i>Find 'Logos Bible Software' in the <u>Main Menu</u>
under the <u>'Wine'</u> category</i>"
    else
        # not a valid 'logos*.msi' file: exit
        errorExit "<b>No valid Logos-x86.msi found.</b>"
    fi
fi

exit 0
